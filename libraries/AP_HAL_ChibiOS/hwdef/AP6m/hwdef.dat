# hw definition file for processing by chibios_hwdef.py
# for AP6 hardware

# define frames
define ALIGN_M3         0x04070001
define ALIGN_M3_OF      0x04070101
define ALIGN_M3_A10     0x04070002

# USB setup
USB_VENDOR 0x2A58 # ALIGN Corporation Limited
USB_PRODUCT 0xA003 # AP6-mini
USB_STRING_MANUFACTURER "ALIGN"

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# crystal frequency
OSCILLATOR_HZ 24000000

# board ID for firmware load
APJ_BOARD_ID 153 # AP_HW_ALIGN_AP6-mini

FLASH_SIZE_KB 2048

# ChibiOS system timer
STM32_ST_USE_TIMER 2

# bootloader takes first sector, param second and third sectors
FLASH_RESERVE_START_KB 384

# use 2 pages for flash storage
# H743 has 16 pages of 128k each
STORAGE_FLASH_PAGE 1
define HAL_STORAGE_SIZE 32768

# order of UARTs (and USB)
# Serial1   Telemetry   UART4
# Serial2   RangeFinder UART7 
# Serial3   RangeFinder UART8
# Serial4   G3P gimbal  UART3
# Serial5   G3P DV      UART6
# Serial6   GPS1        UART2
# Serial7   ESC Telem   UART5
# Serial8   RCIN        UART1

SERIAL_ORDER OTG1 UART4 UART7 UART8 USART6 USART3 USART2 UART5 USART1

# Serial1
PC10 UART4_TX UART4 NODMA
PB8 UART4_RX UART4 NODMA
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL1_BAUD 115

# Serial2
PE8 UART7_TX UART7 NODMA
PE7 UART7_RX UART7 NODMA
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_MAVLink
define DEFAULT_SERIAL2_BAUD 115
define DEFAULT_SERIAL2_OPTIONS 1024

# Serial3
PE1 UART8_TX UART8 NODMA
PE0 UART8_RX UART8 NODMA
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_MAVLink
define DEFAULT_SERIAL3_BAUD 115
define DEFAULT_SERIAL3_OPTIONS 1024

# Serial4
PC6 USART6_TX USART6 NODMA
PC7 USART6_RX USART6 NODMA
define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_Gimbal

# Serial5
PD8 USART3_TX USART3 NODMA
PD9 USART3_RX USART3 NODMA
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_Gimbal

# Serial6 GPS1
PD5 USART2_TX USART2
PD6 USART2_RX USART2
define DEFAULT_SERIAL6_PROTOCOL SerialProtocol_GPS

# Serial7 
PD2 UART5_RX UART5 NODMA
define DEFAULT_SERIAL7_PROTOCOL SerialProtocol_ESCTelemetry

# Serial 8 as RCIN
PA10 USART1_RX USART1
define DEFAULT_SERIAL8_PROTOCOL SerialProtocol_RCIN

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1
PA9 VBUS INPUT OPENDRAIN

# these are the pins for SWD debugging with a STlinkv2 or black-magic probe
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# SPI6 - BARO MS5611 and IMU ICM42688
PA5 SPI6_SCK SPI6
PA6 SPI6_MISO SPI6
PA7 SPI6_MOSI SPI6

# SPI4 - Flash Storage
PE2 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4

# sensor CS and INT
PA4 ICM42688_CS CS
PC4 MS5611_CS CS
PE4 FLASH_CS CS

# define the order that I2C buses 
I2C_ORDER I2C1 I2C2

# I2C1 is on GPS1 port
PB6 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# I2C2 (extra)
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# All I2C are external
define HAL_I2C_INTERNAL_MASK 0

# PWM AUX channels
PE11 TIM1_CH2 TIM1 PWM(1) GPIO(50) # Motor 1
PE13 TIM1_CH3 TIM1 PWM(2) GPIO(51) # Motor 2
PE14 TIM1_CH4 TIM1 PWM(3) GPIO(52) # Motor 3
PE9  TIM1_CH1 TIM1 PWM(4) GPIO(53) # Motor 4
PB0  TIM3_CH3 TIM3 PWM(5) GPIO(54) # Gripper
PD15 TIM4_CH4 TIM4 PWM(6) GPIO(55) # NeoPixel status LEDs
PA2  TIM5_CH3 TIM5 PWM(7) GPIO(56) # NeoPixel Arm LEDs

# ADC
PC0 BATT_CURRENT_SENS ADC1 SCALE(1)
PC1 BATT_VOLTAGE_SENS ADC1 SCALE(1)

define HAL_BATT_MONITOR_DEFAULT 4
define HAL_BATT_CURR_PIN 10
define HAL_BATT_VOLT_PIN 11
define HAL_BATT_VOLT_SCALE 8.5
define HAL_BATT_CURR_SCALE 13.3

# SPI devices
SPIDEV icm42688       SPI6 DEVID1  ICM42688_CS      MODE3   2*MHZ   8*MHZ
SPIDEV ms5611         SPI6 DEVID2  MS5611_CS        MODE3  20*MHZ  20*MHZ
SPIDEV dataflash      SPI4 DEVID1  FLASH_CS         MODE3 104*MHZ 104*MHZ

# 1 IMU
IMU Invensensev3 SPI:icm42688 ROTATION_YAW_90

# enable fast sampling IMU
define HAL_DEFAULT_INS_FAST_SAMPLE 1

# Enable all IMUs to be used and therefore three active EKF Lanes
define HAL_EKF_IMU_MASK_DEFAULT 1

# probe for external compasses
define HAL_PROBE_EXTERNAL_I2C_COMPASSES

# Baro 
BARO MS56XX SPI:ms5611

# enable logging to dataflash
define HAL_LOGGING_DATAFLASH_ENABLED 1
define HAL_LOGGING_DATAFLASH_DRIVER AP_Logger_W25N01GV

# enable scripting and terrain even if there is no SD card
define AP_SCRIPTING_ENABLED 1
define AP_TERRAIN_AVAILABLE 1

# GPIO 
PA15 LED1 OUTPUT HIGH GPIO(80)
PC11 LED2 OUTPUT HIGH GPIO(81)
PD0  LED3 OUTPUT HIGH GPIO(82)
PD1  LED4 OUTPUT HIGH GPIO(83)
PC2 EXTERN_GPIO84 INPUT FLOATING GPIO(84) # Button
PC3 EXTERN_GPIO85 OUTPUT LOW GPIO(85) # Power Enable
PC13 EXTERN_GPIO93 OUTPUT LOW GPIO(93) # Power Enable

# defines for custom panel and power control
define ALIGN_BATTERY_PANEL
define HAL_GPIO_BUTTON_PIN 84
define HAL_GPIO_BUTTON_PRESSED 0
define HAL_GPIO_A_LED_PIN 83
define HAL_GPIO_B_LED_PIN 82
define HAL_GPIO_C_LED_PIN 81
define HAL_GPIO_D_LED_PIN 80
define HAL_GPIO_LED_OFF 0
define HAL_GPIO_LED_ON 1
define HAL_GPIO_MAIN_POWER_PIN 85
define HAL_GPIO_POWER_OFF 1

# bootloader embedding / bootloader flashing not available
define ALIGN_BATTERY_PANEL
define AP_BOOTLOADER_FLASHING_ENABLED 0
